<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>TapTest 3.0</title>
<script src="./pdf.js"></script> 
<script src="./envelopes.js"></script>
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    line-height: 140%;
    font-size: 10pt;
  }
  #the-canvas {
    border: 1px solid black;
    direction: ltr;
  }
  div {
    position: absolute;
    transform-origin:top left;
  }
  div.hider {
    position: relative;
    display: none;
  }
  p {     
    margin: 0 0 0.5em 0;
  }
  text {
    font-family: Courier, monospace;
    font-size: 20px;
    user-select: none;
    text-anchor:middle;
  }
  text.left {
    text-anchor:start;
  }
  text.small {
    font-size: 16px;
  }
  .glow {
    text-shadow: 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white, 0 0 6px white;
  }
  table.t1 td {
    width: 6em;
    user-select: all;
  }
</style>
</head>
<body>
<div id="panel" style="overflow:hidden; white-space:nowrap; text-overflow: ellipsis; width:200px; user-select:none;">
<!--  <input type="file" accept=".pdf" onchange="openPDF(this.files[0]);"><br/> -->
  <p><button onclick="let input = document.createElement('input');
    input.type = 'file'; input.accept = '.pdf';
    input.onchange = _ => {
      const filename_text = document.getElementById('fname');
      filename_text.innerHTML = 'File: ' + input.files[0].name;
      openPDF(input.files[0]);
    };
    input.click();">Open PDF</button></p>
  <span id="controls" style="display:none;">
    <p><span id="fname" ></span></br/>
    Size: <span id="page_width"></span>" X <span id="page_height"></span>"</p>
    <p><button id="button_prev" onclick="pageNum--;
      queueRenderPage(pageNum);">
      Previous</button>
    <button id="button_next" onclick="pageNum++;
      queueRenderPage(pageNum);">
      Next</button> &nbsp;
    Page <span id="page_num"></span> of <span id="page_count"></span></p>
    <p style="margin-top:1em;"><label for="envelope">Envelope:</label>
      <select name="envelope" id="envelope_list" onchange="showEnvelope(this.selectedIndex);"></select>
    </p>
    <div style="position:relative; height:50px;"><p id="envelope_desc" style="font-size:8pt; white-space:normal; overflow:visible;"></p></div>
    <p><button id="tap_left" disabled onclick="tap(true)">Tap Left</button><button id="tap_right" disabled onclick="tap(false)">Tap Right</button></p>
      <input type="checkbox" onchange="rulerOn = !rulerOn; showRuler()"> Ruler<br/>
      <div class='hider' id="ruler_controls">
        <input type="checkbox" checked onchange="snap = !snap; showRuler()"> Snap to fractions<br/>
      </div>
      <input type="checkbox" onchange="omrOn = !omrOn; showOMR()"> OMR codes<br/>
      <div class='hider' id="env_controls">
        <input type="checkbox" onchange="toleranceOn =! toleranceOn; showTolerance()"> Address window tolerance
      </div>
      <div style="position:relative; height:50px;"><p id="coords_desc" style="font-size:8pt; white-space:normal; overflow:visible;"></p></div>

  </span>
</div>
<div id="page" style="display:none;">
  <canvas id="the-canvas"></canvas>
  <svg id="page_svg" style="position:absolute;top:0px;left:0px;">
    <path id='fold-lines' fill='none' stroke-dasharray='5,5' stroke='magenta'/>
  </svg>
</div>
<div id="envelope">
  <svg id="envelope_svg">
    <path id="envelope_path" stroke='red' fill='none'/>
    <path id="tolerance_path" stroke='red' stroke-dasharray='7,7' fill='none'/>
  </svg>
</div>
<div id="page_tools_layer">
  <div id="ruler">
  </div>
  <div id="omr">
  </div>
</div>

<script>
  const PANEL_WIDTH = 285;
  const PADDING = 15;
  const ROUNDQ = 0.55;
  var pageWidthIn, pageHeightIn, scale, pgScale = 1, pxPerIn, pxPerInPaper, tapState, envelopeWidthIn, edata;
  var rulerOn = false, omrOn = false, toleranceOn = false, snap = true;
  var rulerXin = [ 1, 2 ], rulerYin = [ 1, 2 ], rulerXscreen = [], rulerYscreen = [], rulerDragged, eRulerX, eRulerY, eDiff;
  const filter = "<defs><filter id='f1'><feGaussianBlur in='SourceAlpha' stdDeviation='5'/><feColorMatrix values='0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 20 0'/>" +
    "<feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs>";

  const ePanel = document.getElementById("panel");
  const ePage = document.getElementById("page");
  const ePageSvg = document.getElementById("page_svg");
  const eEnvelope = document.getElementById("envelope");
  const eEnvelopeSvg = document.getElementById("envelope_svg");
  const eEnvelopePath = document.getElementById("envelope_path");
  const eFoldlinesPath = document.getElementById("fold-lines");
  const eTolerancePath = document.getElementById("tolerance_path");
  const ePageToolsLayer = document.getElementById("page_tools_layer");
  const eRuler = document.getElementById("ruler");
  const eOMR = document.getElementById("omr");
  const eControls = document.getElementById("controls");
  const eButtonPrev = document.getElementById("button_prev");
  const eButtonNext = document.getElementById("button_next");
  const eTapLeft = document.getElementById("tap_left");
  const eTapRight = document.getElementById("tap_right");
  const ePageWidth = document.getElementById("page_width");
  const ePageHeight = document.getElementById("page_height");
  const eEnvelopeList = document.getElementById("envelope_list");
  const eEnvelopeDesc = document.getElementById("envelope_desc");
  const eEnvelopeControls = document.getElementById("env_controls");
  const eRulerControls = document.getElementById("ruler_controls");
  const eCoordsDesc = document.getElementById("coords_desc");
  const eShowTolerance = document.getElementById("show_tolerance");
    
  ePanel.style.width = PANEL_WIDTH + 'px';
  ePanel.style.left = PADDING + 'px';
  ePanel.style.top = PADDING + 'px';
  ePanel.style.overflow = 'scroll';
  const SCROLL_WIDTH = ePanel.offsetWidth - ePanel.clientWidth + 3;
  ePanel.style.overflow = 'hidden';
  const WORK_OFFSET = PANEL_WIDTH + 2*PADDING;
  const WORK_WIDTH = window.innerWidth - WORK_OFFSET - SCROLL_WIDTH - PADDING;
  ePage.style.left = ePageToolsLayer.style.left = WORK_OFFSET + 'px';
  ePage.style.top = ePageToolsLayer.style.top = PADDING + 'px';
  eEnvelope.style.left = WORK_OFFSET + 'px';
  eEnvelope.style.top = PADDING + 'px';
  ePageSvg.style.width = eEnvelopeSvg.style.width = WORK_WIDTH + 1 + 'px';

  // ------- envelopes ------
  eEnvelopeList.innerHTML += "<option> </option>";
  for (let i = 0; i < envelopes.length; i ++) {
    eEnvelopeList.innerHTML += "<option>" + envelopes[i][0] + " </option>";
  }

  function showEnvelope(e) {
    if (e == 0) {
      eEnvelopePath.setAttribute('d', "M0 0");
      ePage.style.transform = 'scale(1)';
      ePage.style.left = WORK_OFFSET + 'px';
      ePage.style.top = PADDING + 'px';
      ePageToolsLayer.style.transform = 'scale(1)';
      ePageToolsLayer.style.left = WORK_OFFSET + 'px';
      ePageToolsLayer.style.top = PADDING + 'px';
      eFoldlinesPath.setAttribute('d', '');
      eTolerancePath.setAttribute('d', '');
      eTapLeft.disabled = eTapRight.disabled = true;
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = '0';
      eEnvelopeControls.style.display = 'none';
      pgScale = 1;
    }
    else {
      edata = envelopes[e-1];
      if (edata[1] < pageWidthIn) alert('The envelope is more narrow than the page - check the data!');
      fold = 1; while (edata[2] < pageHeightIn/fold) fold++;
      envelopeWidthIn = edata[1];
      pgScale = pageWidthIn/envelopeWidthIn;
      pxPerIn = WORK_WIDTH/envelopeWidthIn;

      let v = edata[2]*pxPerIn;
      eEnvelopeSvg.style.height = v + 'px';
      ePage.style.transform = ePageToolsLayer.style.transform = 'scale(' + pgScale + ')';
      ePage.style.top = ePageToolsLayer.style.top = PADDING + (edata[2] - pageHeightIn/fold - inset)*pxPerIn + 'px';
      let x1 = edata[3]*pxPerIn, y1 = edata[4]*pxPerIn, dx1 = edata[5]*pxPerIn, dy1 = edata[6]*pxPerIn, r1 = edata[7]*pxPerIn, rc1 = r1*ROUNDQ;
      let x2 = edata[8]*pxPerIn, y2 = edata[9]*pxPerIn, dx2 = edata[10]*pxPerIn, dy2 = edata[11]*pxPerIn, r2 = edata[12]*pxPerIn, rc2 = r2*ROUNDQ;
      eEnvelopeDesc.innerHTML = edata[13];

      path = 'M0 0 v' + v + ' h' + WORK_WIDTH + ' v-' + v + ' h-' + WORK_WIDTH +
        ' M' + (x1 + r1) + ' ' + y1 + ' h' + (dx1 - 2*r1) + ' c' + rc1 + ' 0,' + r1 + ' ' + (r1 - rc1) + ',' + r1 + ' ' + r1 +
          ' v' + (dy1 - 2*r1) + ' c0 ' + rc1 + ',-' + (r1 - rc1) + ' ' + r1 + ',-' + r1 + ' ' + r1 +
          ' h-' + (dx1 - 2*r1) + ' c-' + rc1 + ' 0,-' + r1 + ' -' + (r1 - rc1) + ',-' + r1 + ' -' + r1 +
          ' v-' + (dy1 - 2*r1) + ' c0 -' + rc1 + ',' + (r1 - rc1) + ' -' + r1 + ',' + r1 + ' -' + r1;
      if (x2 >= 0) path += ' M' + (x2 + r2) + ' ' + y2 + ' h' + (dx2 - 2*r2) + ' c' + rc2 + ' 0,' + r2 + ' ' + (r2 - rc2) + ',' + r2 + ' ' + r2 +
          ' v' + (dy2 - 2*r2) + ' c0 ' + rc2 + ',-' + (r2 - rc2) + ' ' + r2 + ',-' + r2 + ' ' + r2 +
          ' h-' + (dx2 - 2*r2) + ' c-' + rc2 + ' 0,-' + r2 + ' -' + (r2 - rc2) + ',-' + r2 + ' -' + r2 +
          ' v-' + (dy2 - 2*r2) + ' c0 -' + rc2 + ',' + (r2 - rc2) + ' -' + r2 + ',' + r2 + ' -' + r2;
      eEnvelopePath.setAttribute('d', path);

      path = 'M0 0 ';
      for (let i = 1; i < fold; i++) {
        path += " M2 " + pageHeightIn*i/fold*pxPerInPaper + " h" + (WORK_WIDTH - 4);
      }
      eFoldlinesPath.setAttribute('d', path);
      eEnvelopeControls.style.display = 'block';

      leftTap = inset*pxPerIn + "px";
      rightTap = (edata[1] - pageWidthIn - inset)*pxPerIn + "px";
      tapState = false;
      tap(true);
      showTolerance();
    }
}

function tap(state) {
    if (state == tapState) return;
    tapState = state;
    eTapLeft.disabled = state;
    eTapRight.disabled = !state;
    if (state) { // true = left
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = inset*pxPerIn - 1 + "px";
    }
    else {
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = (envelopeWidthIn - pageWidthIn - inset)*pxPerIn - 1 + "px";
    }
}

function showRuler() {
  if(!rulerOn) {
    eRuler.innerHTML = "";
    eCoordsDesc.innerHTML = "";
    eRulerControls.style.display = "none";
    return;
  }
  eRulerControls.style.display = "block";
  let code = "<svg width='" + pageWidthIn*pxPerInPaper + "px' height='" +  pageHeightIn*pxPerInPaper + "px' style='position:absolute; top:0; left:0;'>" +
    "<path stroke='blue' fill='none' d='";
  for (let i = 1; i < pageHeightIn*16; i ++)
    code += ' M' + WORK_WIDTH + ' ' + (i*pxPerInPaper/16) + 'h-' + ((i%16 == 0) ? 50 : (i%8 == 0) ? 40 : (i%4 == 0) ? 30 : (i%2 == 0) ? 20 : 10);
  for (let i = 1; i < pageWidthIn*16 - 5; i ++)
      code += ' M' + (i*pxPerInPaper/16) + ' 0 v' + ((i%16 == 0) ? 50 : (i%8 == 0) ? 40 : (i%4 == 0) ? 30 : (i%2 == 0) ? 20 : 10);
  code += "'/>";
  for (let i = 1; i < pageHeightIn; i ++)
    code += "<text stroke='blue' style='text-anchor:end' x='" + (WORK_WIDTH - 60) + "' y='" + (i*pxPerInPaper + 6) + "'>" + i + "</text>";
  for (let i = 1; i < (pageWidthIn*16 - 5)/16; i ++)
    code += "<text stroke='blue' style='text-anchor:middle' x='" + (i*pxPerInPaper) + "' y='74'>" + i + "</text>";
  code += "</svg>";
  for (let i = 0; i < 2; i ++) {
    code += "<svg id='rulerx" + i + "' width='21' height='" + (pageHeightIn*pxPerInPaper + 20) + "' style='position:absolute;top:-21px;left:" + (rulerXin[i]*pxPerInPaper - 11) + "px';'>" +
        "<path id='rulerxh" + i + "' rulerid='" + i + "' fill='white' stroke='black' d='M1 1 h20 l-10 20 l-10 -20' style='cursor:move;'/>" +
        "<path fill='none' stroke='blue' d='M11 21 v" + pageHeightIn*pxPerInPaper + "'/></svg>" +
      "<svg id='rulery" + i + "' height='21' width='" + (pageWidthIn*pxPerInPaper + 20) + "' style='position:absolute;left:-21px;top:" + (rulerYin[i]*pxPerInPaper - 11) + "px';'>" +
        "<path id='ruleryh" + i + "' rulerid='" + i + "' fill='white' stroke='black' d='M1 1 v20 l20 -10 l-20 -10' style='cursor:move;'/>" +
        "<path fill='none' stroke='blue' d='M21 11 h" + pageHeightIn*pxPerInPaper + "'/></svg>";
  }
  code += "<svg id='diff' width='" + pageWidthIn*pxPerInPaper + "px' height='" +  pageHeightIn*pxPerInPaper + "px' style='position:absolute; top:0; left:0;'></svg>";
  eRuler.innerHTML = code;
  eRulerX = [ document.getElementById("rulerx0"), document.getElementById("rulerx1") ];
  eRulerY = [ document.getElementById("rulery0"), document.getElementById("rulery1") ];
  eDiff = document.getElementById("diff");

  document.getElementById('rulerxh0').onmousedown = document.getElementById('rulerxh1').onmousedown = dragX;
  document.getElementById('ruleryh0').onmousedown = document.getElementById('ruleryh1').onmousedown = dragY;
  updateCoords();
}


function dragX(e) {
  rulerDragged = parseInt(this.getAttribute("rulerid"));
  e = e || window.event;
  e.preventDefault();
  shift = rulerXin[rulerDragged]*pxPerInPaper*pgScale - e.clientX;
  document.onmouseup = endDrag;
  document.onmousemove = moveX;
}

function moveX(e) {
    e = e || window.event;
    e.preventDefault();
    let x = (e.clientX + shift)/pxPerInPaper/pgScale;
    if (x < 0) x = 0;
    if (x > pageWidthIn) x = pageWidthIn;
    if (snap) x = Math.round(x*16)/16;
    rulerXin[rulerDragged] = x;
    eRulerX[rulerDragged].style.left = (x*pxPerInPaper - 11) + 'px';
    updateCoords();
}

function dragY(e) {
  rulerDragged = parseInt(this.getAttribute("rulerid"));
  e = e || window.event;
  e.preventDefault();
  shift = rulerYin[rulerDragged]*pxPerInPaper*pgScale - e.clientY;
  document.onmouseup = endDrag;
  document.onmousemove = moveY;
}

function moveY(e) {
    e = e || window.event;
    e.preventDefault();
    let y = (e.clientY + shift)/pxPerInPaper/pgScale;
    if (y < 0) y = 0;
    if (y > pageHeightIn) y = pageHeightIn;
    if (snap) y = Math.round(y*16)/16;
    rulerYin[rulerDragged] = y;
    eRulerY[rulerDragged].style.top = (y*pxPerInPaper - 11) + 'px';
    updateCoords();
}

function endDrag() {
    document.onmouseup = null;
    document.onmousemove = null;
}

function updateCoords() {
  let x1i = (rulerXin[0] < rulerXin[1]) ? rulerXin[0] : rulerXin[1];
  let x2i = (rulerXin[0] < rulerXin[1]) ? rulerXin[1] : rulerXin[0];
  let y1i = (rulerYin[0] < rulerYin[1]) ? rulerYin[0] : rulerYin[1];
  let y2i = (rulerYin[0] < rulerYin[1]) ? rulerYin[1] : rulerYin[0];
  let x1 = x1i*pxPerInPaper, x2 = x2i*pxPerInPaper, y1 = y1i*pxPerInPaper, y2 = y2i*pxPerInPaper;

  diff = filter;
  if (snap)
    diff += outputFraction(x2i - x1i, (x1 + x2)/2, 135);
  else {
    diff += "<text stroke='blue' class='glow' x='" + (x1 + x2)/2 + "' y='135'>" + 
    (x2i - x1i).toFixed(2) + "\"</text>";
  }
  diff += "<path stroke='blue' fill='transparent' d='M" + x1 + " 100 ";
  if (x2 - x1 > 50)
      diff += "l10 -10 l-10 10 l10 10 l-10 -10 h" + (x2 - x1) + " l-10 -10 l10 10 l-10 10 l10 -10'/>";
  else
      diff += "l-10 -10 m0 20 l10 -10 h-20 m" + (x2 - x1 + 40) + " 0 h-20 l10 -10 m0 20 l-10 -10'/>";

  if (snap)
    diff += outputFraction(y2i - y1i, 60, (y1 + y2 + 12)/2);
  else {
    diff += "<text stroke='blue' class='glow' x='60' y='" + (y1 + y2 + 12)/2 + "'>" + (y2i - y1i).toFixed(2) + "\"</text>";
  }

  diff += "<path stroke='blue' fill='transparent' d='M10 " + y1;
  if (y2 - y1 > 50)
      diff += "l-10 10 l10 -10 l10 10 l-10 -10 v" + (y2 - y1) + " l-10 -10 l10 10 l10 -10 l-10 10'/>";
    else
        diff += "l-10 -10 m20 0 l-10 10 v-20 m0 " + (y2 - y1 + 40) + " v-20 l-10 10 m20 0 l-10 -10'/>";

    eDiff.innerHTML = diff;

  if (snap) {
    eCoordsDesc.innerHTML = "<table class='t1'><tr><td>X1: " + outputFractionText(x1i) + "\"</td><td>X2: " + outputFractionText(x2i) + "\"</td><td>DX: " + outputFractionText(x2i - x1i) + "\"</td></tr>" +
      "<tr><td>Y1: " + outputFractionText(y1i) + "\"</td><td>Y2: " + outputFractionText(y2i) + "\"</td><td>DY: " + outputFractionText(y2i - y1i) + "\"</td></tr></table>";
  } else {
    eCoordsDesc.innerHTML = "<table class='t1'><tr><td>X1: " + x1i.toFixed(2) + "\"</td><td>X2: " + x2i.toFixed(2) + "\"</td><td>DX: " + (x2i - x1i).toFixed(2) + "\"</td></tr>" +
      "<tr><td>Y1: " + y1i.toFixed(2) + "\"</td><td>Y2: " + y2i.toFixed(2) + "\"</td><td>DY: " + (y2i - y1i).toFixed(2) + "\"</td></tr></table>";
  }
  
}

function fractionsOf2(n) {
    let p0 = Math.round(n*16)/16;
    let p1 = Math.floor(p0);
    let p2 = Math.round((p0 - p1)*16);
    let p3 = 16;
    if (p2 > 0)
      while (p2%2 == 0) { p2 /= 2; p3 /= 2; }
    return [ p1, p2, p3 ];
}

function outputFraction(n, x, y) {
  let p = fractionsOf2(n);

  pos = 1;
  if (p[1] == 0 || p[0] > 0) pos ++;
  if (p[0] > 9) pos ++;
  if (p[1] > 0) pos += 1.6;
  const charw = 14, charh = 8;
  let offset = x - pos*charw/2;
  let out = "";

  if (p[1] == 0 || p[0] > 0) {
    if (p[0] > 9) {
      out += "<text stroke='blue' class='glow left' x='" + offset + "' y='" + y + "'>" + Math.floor(p[0]/10) + "</text>";
      offset += charw;
    }
    out += "<text stroke='blue' class='glow left' x='" + offset + "' y='" + y + "'>" + p[0]%10 + "</text>";
    offset += charw;
  }
  if (p[1] != 0) {
    offset += charw*0.8;
    out += "<text stroke='blue' class='glow small' x='" + offset + "' y='" + (y - charh) + "'>" + p[1] + "</text>";
    out += "<text stroke='blue' class='glow small' x='" + offset + "' y='" + (y + charh) + "'>" + p[2] + "</text>";
    out += "<path stroke='blue' fill='none' d='M" + (offset - charw/2) + " " + (y - charh + 3) + " h" + charw +"'/>";
    offset += charw*0.8;
  }
  out += "<text stroke='blue' class='glow left' x='" + offset + "' y='" + y + "'>\"</text>";
  return out;
}

function outputFractionText(n) {
  let p = fractionsOf2(n), out = "";
  if (p[0] > 0 || p[1] == 0) out += p[0];
  if (p[0] > 0 && p[1] > 0) out += ' ';
  if (p[1] > 0) out += p[1] + '/' + p[2];
  return out;
}

function showOMR() {
  if (!omrOn) {
    eOMR.innerHTML = ""; return;
  } 
  const OMR_XPOS = 0.45;
  let omr_code = "<svg width='" + pageWidthIn*pxPerInPaper + "px' height='" +  pageHeightIn*pxPerInPaper + "px' style='position:absolute; top:0; left:0;'>" + filter;
  const omrCode = [ 'TPC 8', 'TPC 4', 'TPC 2', 'TPC 1', 'SEL 5', 'SEL 4', 'SEL 3', 'QC', 'DVRT', 'SFTY', 'SEL 2', 'SEL 1', 'SEQ 2', 'SEQ 1', 'EOC', 'BM' ];
  for (let i = 0; i < 16; i ++) {
    omr_code += "<text class='glow left' stroke='green' x='" + OMR_XPOS*pxPerInPaper + "' y='" + (i*0.125 + 2.15)*pxPerInPaper + "'>" + omrCode[i] + "</text>";
  }
  omr_code += "</svg>";
  eOMR.innerHTML = omr_code;
}

function showTolerance() {
  if (!toleranceOn) {
    eTolerancePath.setAttribute('d', ''); return;
  }
  eTolerancePath.setAttribute('d', 'M' + (edata[3]+1/8)*pxPerIn + ' ' + (edata[4]+1/8)*pxPerIn + ' v' +  (edata[6] - 1/4)*pxPerIn + ' h' + (edata[5]-1/4)*pxPerIn + ' v-' +  (edata[6] - 1/4)*pxPerIn);
}



  // ------ pdf render ------
  var pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.js';
  var pdfDoc = null,
    pageNum = 1,
    pageRendering = false,
    pageNumPending = null,
  //  scale = 10,
    canvas = document.getElementById('the-canvas'),
    ctx = canvas.getContext('2d');

  /**
   * Get page info from document, resize canvas accordingly, and render page.
   * @param num Page number.
   */
  function renderPage(num) {
    eButtonPrev.disabled = (num > 1) ? false : true;
    eButtonNext.disabled = (num < pdfDoc.numPages) ? false : true;
    
    pageRendering = true;

  // Using promise to fetch the page
    pdfDoc.getPage(num).then(function(page) {
      var viewport = page.getViewport({scale: 1});
      pageWidthIn = viewport.width/72;
      pageHeightIn = viewport.height/72;
      ePageWidth.innerHTML = pageWidthIn;
      ePageHeight.innerHTML = pageHeightIn;
      scale = WORK_WIDTH / viewport.width;
      pxPerInPaper = WORK_WIDTH / pageWidthIn;
      viewport = page.getViewport({scale: scale});
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      ePageSvg.style.height = pxPerInPaper*pageHeightIn + 1 + 'px';
      showRuler();

      // Render PDF page into canvas context
      var renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      var renderTask = page.render(renderContext);

      // Wait for rendering to finish
      renderTask.promise.then(function() {
        pageRendering = false;
        if (pageNumPending !== null) {
          // New page rendering is pending
          renderPage(pageNumPending);
          pageNumPending = null;
        }
      });
    });

  // Update page counters
  document.getElementById('page_num').textContent = num;
  }

  /**
   * If another page rendering in progress, waits until the rendering is
   * finised. Otherwise, executes rendering immediately.
   */
  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

   /**
   * Asynchronously downloads PDF file
   */
  function openPDF(f) {
    pageNum = 1;

    pdfjsLib.getDocument(URL.createObjectURL(f)).promise.then(function(pdfDoc_) {
      pdfDoc = pdfDoc_;
      document.getElementById('page_count').textContent = pdfDoc.numPages;

      // Initial/first page rendering
      renderPage(pageNum);

      ePage.style.display = 'block';
      eControls.style.display = 'block';
    });
  }

</script>

</body>
</html>