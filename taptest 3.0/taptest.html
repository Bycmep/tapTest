<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>TapTest 3.0</title>
<script src="./pdf.js"></script> 
<script src="./envelopes.js"></script>
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    line-height: 140%;
    font-size: 10pt;
  }
#the-canvas {
  border: 1px solid black;
  direction: ltr;
}
div {
  position: absolute;
  transform-origin:top left;
}
p {     
  margin: 0 0 0.5em 0;
}
text {
        font-family: Courier, monospace;
        font-size: 20px;
        user-select: none;
    }
</style>
</head>
<body>
<div id="panel" style="overflow:hidden; white-space:nowrap; text-overflow: ellipsis; width:200px; user-select:none;">
<!--  <input type="file" accept=".pdf" onchange="openPDF(this.files[0]);"><br/> -->
  <p><button onclick="let input = document.createElement('input');
    input.type = 'file'; input.accept = '.pdf';
    input.onchange = _ => {
      const filename_text = document.getElementById('fname');
      filename_text.innerHTML = 'File: ' + input.files[0].name;
      openPDF(input.files[0]);
    };
    input.click();">Open PDF</button></p>
  <span id="controls" style="display:none;">
    <p><span id="fname" ></span></br/>
    Size: <span id="page_width"></span>" X <span id="page_height"></span>"</p>
    <p><button id="button_prev" onclick="pageNum--;
      queueRenderPage(pageNum);">
      Previous</button>
    <button id="button_next" onclick="pageNum++;
      queueRenderPage(pageNum);">
      Next</button> &nbsp;
    Page <span id="page_num"></span> of <span id="page_count"></span></p>
    <p style="margin-top:1em;"><label for="envelope">Envelope:</label>
      <select name="envelope" id="envelope_list" onchange="showEnvelope(this.selectedIndex);"></select>
    </p>
    <div style="position:relative; height:50px;"><p id="envelope_desc" style="font-size:8pt; white-space:normal; overflow:visible;"></p></div>
    <p><button id="tap_left" disabled onclick="tap(true)">Tap Left</button><button id="tap_right" disabled onclick="tap(false)">Tap Right</button></p>
    <p>
      <input type="checkbox" onchange="rulerOn = !rulerOn; showRuler()"> Ruler<br/>
      <input type="checkbox" disabled id="show_tolerance" onchange="showTolerance()"> Address window tolerance<br/>
      <input type="checkbox" onchange="showOMR()"> OMR codes
    </p>

  </span>
</div>
<div id="page" style="display:none;">
  <canvas id="the-canvas"></canvas>
  <svg id="page_svg" style="position:absolute;top:0px;left:0px;">
    <path id='fold-lines' fill='none' stroke-dasharray='5,5' stroke='magenta'/>
  </svg>
</div>
<div id="envelope">
  <svg id="envelope_svg">
    <path id="envelope_path" stroke='red' fill='none'/>
    <path id="tolerance_path" stroke='red' stroke-dasharray='7,7' fill='none'/>
  </svg>
</div>
<div id="page_tools_layer">
  <div id="ruler">
  </div>
  <div id="omr">
  </div>
</div>

<script>
  const PANEL_WIDTH = 285;
  const PADDING = 15;
  const ROUNDQ = 0.55;
  var pageWidthIn, pageHeightIn, scale, pxPerInPaper, tapState, envelopeWidthIn;
  var rulerOn = false;



  const ePanel = document.getElementById("panel");
  const ePage = document.getElementById("page");
  const ePageSvg = document.getElementById("page_svg");
  const eEnvelope = document.getElementById("envelope");
  const eEnvelopeSvg = document.getElementById("envelope_svg");
  const eEnvelopePath = document.getElementById("envelope_path");
  const eFoldlinesPath = document.getElementById("fold-lines");
  const ePageToolsLayer = document.getElementById("page_tools_layer");
  const eRuler = document.getElementById("ruler");
  const eControls = document.getElementById("controls");
  const eButtonPrev = document.getElementById("button_prev");
  const eButtonNext = document.getElementById("button_next");
  const eTapLeft = document.getElementById("tap_left");
  const eTapRight = document.getElementById("tap_right");
  const ePageWidth = document.getElementById("page_width");
  const ePageHeight = document.getElementById("page_height");
  const eEnvelopeList = document.getElementById("envelope_list");
  const eEnvelopeDesc = document.getElementById("envelope_desc");
  const eShowTolerance = document.getElementById("show_tolerance");

  ePanel.style.width = PANEL_WIDTH + 'px';
  ePanel.style.left = PADDING + 'px';
  ePanel.style.top = PADDING + 'px';
  ePanel.style.overflow = 'scroll';
  const SCROLL_WIDTH = ePanel.offsetWidth - ePanel.clientWidth + 3;
  ePanel.style.overflow = 'hidden';
  const WORK_OFFSET = PANEL_WIDTH + 2*PADDING;
  const WORK_WIDTH = window.innerWidth - WORK_OFFSET - SCROLL_WIDTH - PADDING;
  ePage.style.left = ePageToolsLayer.style.left = WORK_OFFSET + 'px';
  ePage.style.top = ePageToolsLayer.style.top = PADDING + 'px';
  eEnvelope.style.left = WORK_OFFSET + 'px';
  eEnvelope.style.top = PADDING + 'px';
  ePageSvg.style.width = eEnvelopeSvg.style.width = WORK_WIDTH + 1 + 'px';

  // ------- envelopes ------
  eEnvelopeList.innerHTML += "<option> </option>";
  for (let i = 0; i < envelopes.length; i ++) {
    eEnvelopeList.innerHTML += "<option>" + envelopes[i][0] + " </option>";
  }

  function showEnvelope(e) {
    if (e == 0) {
      eEnvelopePath.setAttribute('d', "M0 0");
      ePage.style.transform = 'scale(1)';
      ePage.style.left = WORK_OFFSET + 'px';
      ePage.style.top = PADDING + 'px';
      ePageToolsLayer.style.transform = 'scale(1)';
      ePageToolsLayer.style.left = WORK_OFFSET + 'px';
      ePageToolsLayer.style.top = PADDING + 'px';
      eFoldlines.innerHTML = "";
      eTolerances.innerHTML = "";
      eShowTolerances.disabled = true;
      eShowTolerances.checked = false;
      eTapLeft.disabled = eTapRight.disabled = true;
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = '0';
    }
    else {
      edata = envelopes[e-1];
      if (edata[1] < pageWidthIn) alert('The envelope is more narrow than the page - check the data!');
      fold = 1; while (edata[2] < pageHeightIn/fold) fold++;
      envelopeWidthIn = edata[1];
      pxPerIn = WORK_WIDTH/envelopeWidthIn;

      let v = edata[2]*pxPerIn;
      eEnvelopeSvg.style.height = v + 'px';
      ePage.style.transform = ePageToolsLayer.style.transform = 'scale(' + pageWidthIn/edata[1] + ')';
      ePage.style.top = ePageToolsLayer.style.top = PADDING + (edata[2] - pageHeightIn/fold - inset)*pxPerIn + 'px';
      console.log(eEnvelopePath);
      console.log(eEnvelopePath.getAttribute('d'));
      let x1 = edata[3]*pxPerIn, y1 = edata[4]*pxPerIn, dx1 = edata[5]*pxPerIn, dy1 = edata[6]*pxPerIn, r1 = edata[7]*pxPerIn, rc1 = r1*ROUNDQ;
      let x2 = edata[8]*pxPerIn, y2 = edata[9]*pxPerIn, dx2 = edata[10]*pxPerIn, dy2 = edata[11]*pxPerIn, r2 = edata[12]*pxPerIn, rc2 = r2*ROUNDQ;
      eEnvelopeDesc.innerHTML = edata[13];

      path = 'M0 0 v' + v + ' h' + WORK_WIDTH + ' v-' + v + ' h-' + WORK_WIDTH +
        ' M' + (x1 + r1) + ' ' + y1 + ' h' + (dx1 - 2*r1) + ' c' + rc1 + ' 0,' + r1 + ' ' + (r1 - rc1) + ',' + r1 + ' ' + r1 +
          ' v' + (dy1 - 2*r1) + ' c0 ' + rc1 + ',-' + (r1 - rc1) + ' ' + r1 + ',-' + r1 + ' ' + r1 +
          ' h-' + (dx1 - 2*r1) + ' c-' + rc1 + ' 0,-' + r1 + ' -' + (r1 - rc1) + ',-' + r1 + ' -' + r1 +
          ' v-' + (dy1 - 2*r1) + ' c0 -' + rc1 + ',' + (r1 - rc1) + ' -' + r1 + ',' + r1 + ' -' + r1;
      if (x2 != 0) path += ' M' + (x2 + r2) + ' ' + y2 + ' h' + (dx2 - 2*r2) + ' c' + rc2 + ' 0,' + r2 + ' ' + (r2 - rc2) + ',' + r2 + ' ' + r2 +
          ' v' + (dy2 - 2*r2) + ' c0 ' + rc2 + ',-' + (r2 - rc2) + ' ' + r2 + ',-' + r2 + ' ' + r2 +
          ' h-' + (dx2 - 2*r2) + ' c-' + rc2 + ' 0,-' + r2 + ' -' + (r2 - rc2) + ',-' + r2 + ' -' + r2 +
          ' v-' + (dy2 - 2*r2) + ' c0 -' + rc2 + ',' + (r2 - rc2) + ' -' + r2 + ',' + r2 + ' -' + r2;
      eEnvelopePath.setAttribute('d', path);

      path = 'M0 0 ';
      for (let i = 1; i < fold; i++) {
        path += " M2 " + pageHeightIn*i/fold*pxPerInPaper + " h" + (WORK_WIDTH - 4);
      }
      eFoldlinesPath.setAttribute('d', path);
      eShowTolerance.disabled = false;

      leftTap = inset*pxPerIn + "px";
      rightTap = (edata[1] - pageWidthIn - inset)*pxPerIn + "px";
      tapState = false;
      tap(true);
      showTolerance();
    }
}

function tap(state) {
    if (state == tapState) return;
    tapState = state;
    eTapLeft.disabled = state;
    eTapRight.disabled = !state;
    if (state) { // true = left
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = inset*pxPerIn - 1 + "px";
    }
    else {
      ePage.style.marginLeft = ePageToolsLayer.style.marginLeft = (envelopeWidthIn - pageWidthIn - inset)*pxPerIn - 1 + "px";
    }
}

function showRuler() {
  if(!rulerOn) {
    eRuler.innerHTML = ""; return;
  }
  let code = "<svg width='" + pageWidthIn*pxPerInPaper + "px' height='" +  pageHeightIn*pxPerInPaper + "px' style='position:absolute; top:0; left:0;'>" +
    "<path stroke='blue' fill='none' d='";
  for (let i = 1; i < pageHeightIn*16; i ++)
    code += ' M' + WORK_WIDTH + ' ' + (i*pxPerInPaper/16) + 'h-' + ((i%16 == 0) ? 50 : (i%8 == 0) ? 40 : (i%4 == 0) ? 30 : (i%2 == 0) ? 20 : 10);
  for (let i = 1; i < pageWidthIn*16 - 5; i ++)
      code += ' M' + (i*pxPerInPaper/16) + ' 0 v' + ((i%16 == 0) ? 50 : (i%8 == 0) ? 40 : (i%4 == 0) ? 30 : (i%2 == 0) ? 20 : 10);
  code += "'/>";
  for (let i = 1; i < pageHeightIn; i ++)
    code += "<text stroke='blue' style='text-anchor:end' x='" + (WORK_WIDTH - 60) + "' y='" + (i*pxPerInPaper + 6) + "'>" + i + "</text>";
  for (let i = 1; i < (pageWidthIn*16 - 5)/16; i ++)
    code += "<text stroke='blue' style='text-anchor:middle' x='" + (i*pxPerInPaper) + "' y='74'>" + i + "</text>";
  code += "</svg>"
//  code += "<svg width='" + pageWidthIn*pxPerInPaper + "px' height='" +  pageHeightIn*pxPerInPaper + "px' style='position:absolute; top:0; left:0;'>" +
//    <svg id="movable-ruler-x-h0" ruler_id="0" style="position:absolute; width:22px; height:22px; cursor:move;">
//                            <path fill="white" stroke="black" d="M1 1 h20 l-10 20 l-10 -20"/>
  eRuler.innerHTML = code;

for (let i = 0; i < mRulerXH.length; i++) {
    mRulerXH[i].style.top = pdfHolder.clientTop - 21 + 'px';
    mRulerXH[i].style.left = pdfHolder.clientLeft - 10 + rulerx[i] + 'px';
    mRulerX[i].style.left = rulerx[i] + "px";
}    
for (let i = 0; i < mRulerYH.length; i++) {
    mRulerYH[i].style.top = pdfHolder.clientTop - 10 + rulery[i] + 'px';
    mRulerYH[i].style.left = pdfHolder.clientLeft - 21 + 'px';
    mRulerY[i].style.top = rulery[i] + "px";
}

}



function showTolerance() {

}



  // ------ pdf render ------
  var pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.js';
  var pdfDoc = null,
    pageNum = 1,
    pageRendering = false,
    pageNumPending = null,
  //  scale = 10,
    canvas = document.getElementById('the-canvas'),
    ctx = canvas.getContext('2d');

  /**
   * Get page info from document, resize canvas accordingly, and render page.
   * @param num Page number.
   */
  function renderPage(num) {
    eButtonPrev.disabled = (num > 1) ? false : true;
    eButtonNext.disabled = (num < pdfDoc.numPages) ? false : true;
    
    pageRendering = true;

  // Using promise to fetch the page
    pdfDoc.getPage(num).then(function(page) {
      var viewport = page.getViewport({scale: 1});
      pageWidthIn = viewport.width/72;
      pageHeightIn = viewport.height/72;
      ePageWidth.innerHTML = pageWidthIn;
      ePageHeight.innerHTML = pageHeightIn;
      scale = WORK_WIDTH / viewport.width;
      pxPerInPaper = WORK_WIDTH / pageWidthIn;
      viewport = page.getViewport({scale: scale});
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      ePageSvg.style.height = pxPerInPaper*pageHeightIn + 1 + 'px';
      showRuler();

      // Render PDF page into canvas context
      var renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      var renderTask = page.render(renderContext);

      // Wait for rendering to finish
      renderTask.promise.then(function() {
        pageRendering = false;
        if (pageNumPending !== null) {
          // New page rendering is pending
          renderPage(pageNumPending);
          pageNumPending = null;
        }
      });
    });

  // Update page counters
  document.getElementById('page_num').textContent = num;
  }

  /**
   * If another page rendering in progress, waits until the rendering is
   * finised. Otherwise, executes rendering immediately.
   */
  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

   /**
   * Asynchronously downloads PDF file
   */
  function openPDF(f) {
    pageNum = 1;

    pdfjsLib.getDocument(URL.createObjectURL(f)).promise.then(function(pdfDoc_) {
      pdfDoc = pdfDoc_;
      document.getElementById('page_count').textContent = pdfDoc.numPages;

      // Initial/first page rendering
      renderPage(pageNum);

      ePage.style.display = 'block';
      eControls.style.display = 'block';
    });
  }

</script>

</body>
</html>