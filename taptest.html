<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.228/pdf.min.js"></script>
<script src="./envelopes.js"></script>
<style>
    .box {
        border:1px solid rgba(0,0,0,0.2);
        box-sizing: border-box;
        margin: 0;
        display: none;
    }
    text {
        font-family: Courier, monospace;
        font-size: 20px;
    }
</style>
</head>
<body>
    <table style="font-family: Arial, Helvetica, sans-serif; font-size: 10pt;">
        <tr style="vertical-align: top;">
            <td id="img-panel" style="height:auto;">
                <svg id="envelope" style="position:absolute; z-index:2; width:1000px; transform-origin:top left;"></svg>
                <div id="pdf-holder" style="position:absolute;margin:0;">
                    <svg id="foldlines" style="position:absolute; z-index:1; transform-origin:top left;"></svg>
                    <svg id="ruler" style="position:absolute; z-index:3; display:none; transform-origin:top left;"></svg>
                    <svg id="omr" style="position:absolute; z-index:4; display:none; transform-origin:top left;"></svg>
                    <div id="loading" class="box" style="text-align:center;vertical-align:center;height:300px;line-height:300px;font-size:20pt;"><b>Loading...</b></div>
                    <canvas id="pdf-canvas" class="box" width="2000px"></canvas>
                </div>
            </td>
            <td>&nbsp;</td>
            <td>
                <input type="file" accept=".pdf" onchange="openPDF(this.files[0]);"> 
                <div id="pdf-controls" style="display:none;">
                    <button id="pdf-prev" onclick="prevPage();">Previous</button>
                    <button id="pdf-next"onclick="nextPage();">Next</button>
                    &nbsp;Page&nbsp;<span id="pdf-current-page"></span>&nbsp;of&nbsp;<span id="pdf-total-pages"></span><br/><br/>
                    <label for="envelope">Envelope:</label>
                    <select name="envelope" id="envelope-list" onchange="showEnvelope(this.selectedIndex);"></select>
                    <br/><button id="tap-left" disabled onclick="tap(true)">Tap Left</button>
                    <button id="tap-right" disabled onclick="tap(false)">Tap Right</button><br/><br/>
                    <input type="checkbox" onchange="showRuler()">&nbsp;Ruler<br/>
                    <input type="checkbox" onchange="showOMR()">&nbsp;OMR codes<br/>
                </div>
            </td>
        </tr>
    </table>
    <script>

var left = true, leftTap, rightTap, fold;
const imgPanel = document.getElementById("img-panel");
const loading = document.getElementById("loading");
const pdfControls = document.getElementById("pdf-controls");
const pdfCanvas = document.getElementById("pdf-canvas");
const pdfHolder = document.getElementById("pdf-holder");
const pdfCurrentPage = document.getElementById("pdf-current-page");
const pdfTotalPages = document.getElementById("pdf-total-pages");
const pdfPrev = document.getElementById("pdf-prev");
const pdfNext = document.getElementById("pdf-next");
const envelope = document.getElementById("envelope");
const tapLeft = document.getElementById("tap-left");
const tapRight = document.getElementById("tap-right");
const select = document.getElementById("envelope-list");
const ruler = document.getElementById("ruler");
const omr = document.getElementById("omr");
const foldlines = document.getElementById("foldlines");

imgPanel.style.width = LEFT_PANEL_WIDTH + 'px';
imgPanel.style.maxWidth = LEFT_PANEL_WIDTH + 'px';
imgPanel.style.minWidth = LEFT_PANEL_WIDTH + 'px';
pdfCanvas.style.width = LEFT_PANEL_WIDTH + 'px';
loading.style.width = LEFT_PANEL_WIDTH + 'px';

select.innerHTML += "<option> </option>";
for (let i = 0; i < envelopes.length; i ++) {
    select.innerHTML += "<option>" + envelopes[i][0] + " </option>";
}

const page_in2px = LEFT_PANEL_WIDTH / PAPER_WIDTH;
const page_height = PAPER_HEIGHT * page_in2px;
ruler.style.width = LEFT_PANEL_WIDTH + 'px';
ruler.style.height = page_height + 'px';
omr.style.width = LEFT_PANEL_WIDTH + 'px';
omr.style.height = page_height + 'px';
foldlines.style.width = LEFT_PANEL_WIDTH + 'px';
foldlines.style.height = page_height + 'px';

let ruler_code = "<path stroke='blue' fill='transparent' d='";
for (let i = 1; i < PAPER_HEIGHT*16; i ++) {
    ruler_code += ' M' + LEFT_PANEL_WIDTH + ' ' + (i*page_in2px/16) + 'h-';
    if (i % 16 == 0) ruler_code += 50;
    else if (i % 8 == 0) ruler_code += 40;
    else if (i % 4 == 0) ruler_code += 30;
    else if (i % 2 == 0) ruler_code += 20;
    else ruler_code += 10;
}
for (let i = 1; i < PAPER_WIDTH*16 - 5; i ++) {
    ruler_code += ' M' + (i*page_in2px/16) + ' 0 v';
    if (i % 16 == 0) ruler_code += 50;
    else if (i % 8 == 0) ruler_code += 40;
    else if (i % 4 == 0) ruler_code += 30;
    else if (i % 2 == 0) ruler_code += 20;
    else ruler_code += 10;
}
ruler_code += "'/>";
for (let i = 1; i < PAPER_HEIGHT; i ++) {
    let o = (i > 9) ? 86 : 75;
    ruler_code += "<text stroke='blue' x='" + (LEFT_PANEL_WIDTH - o) + "' y='" + (i*page_in2px + 6) + "'>" + i + "</text>";
}
for (let i = 1; i < (PAPER_WIDTH*16 - 5)/16; i ++) {
    let o = (i > 9) ? 18 : 7;
    ruler_code += "<text stroke='blue' x='" + (i*page_in2px - o) + "' y='74'>" + i + "</text>";
}
ruler.innerHTML = ruler_code;

let omr_code = "<path stroke='white' fill='white' d='M80 332 v330 h72 v-330 h-72'/>";
const omrCode = [ 'TPC 8', 'TPC 4', 'TPC 2', 'TPC 1', 'SEL 5', 'SEL 4', 'SEL 3', 'QC', 'DVRT', 'SFTY', 'SEL 2', 'SEL 1', 'SEQ 2', 'SEQ 1', 'EOC', 'BM' ];
for (let i = 0; i < 16; i ++) {
    omr_code += "<text stroke='green' x='85' y='" + (i*20.55 + 352) + "'>" + omrCode[i] + "</text>";
}
omr.innerHTML = omr_code;

function showRuler() {
    if (ruler.style.display == 'none') ruler.style.display = 'block';
    else ruler.style.display = 'none';
}

function showOMR() {
    if (omr.style.display == 'none') omr.style.display = 'block';
    else omr.style.display = 'none';
}

function tap(l) {
    if (l == left) return;
    left = l;
    tapLeft.disabled = l;
    tapRight.disabled = !l;
    if (left) {
        pdfHolder.style.marginLeft = leftTap;
    }
    else {
        pdfHolder.style.marginLeft = rightTap;
    }
}

function showEnvelope(e) {
    if (e == 0) {
        envelope.innerHTML = "";
        pdfCanvas.style.width = LEFT_PANEL_WIDTH + 'px';
        pdfHolder.style.marginTop = "0";
        pdfHolder.style.marginLeft = "0";
        ruler.style.transform = 'scale(1)';
        omr.style.transform = 'scale(1)';
        foldlines.innerHTML = "";
    }
    else {
        let edata = envelopes[e-1];
        if (edata[1] < PAPER_WIDTH) alert('The envelope is more narrow than the page - check the data!');
        fold = 1; while (edata[2] < PAPER_HEIGHT/fold) fold++;

        let h = Math.round(edata[2] * 1000 / edata[1]);
        envelope.style.height = (h + 1) + 'px';
        envelope.style.transform = 'scale(' + LEFT_PANEL_WIDTH/1000 + ')';
        ruler.style.transform = 'scale(' + PAPER_WIDTH/edata[1] + ')';
        omr.style.transform = 'scale(' + PAPER_WIDTH/edata[1] + ')';
        foldlines.style.transform = 'scale(' + PAPER_WIDTH/edata[1] + ')';
        envelope.innerHTML = "<path stroke='red' fill='transparent' d='M0 0 v" + h + " h" + 1000 + " v-" + h + " h-" + 1000 + " " + edata[3] + "'/>";
        let inch2px = LEFT_PANEL_WIDTH/edata[1];
        pdfCanvas.style.width = PAPER_WIDTH*inch2px + 'px';
        let topTap = ((edata[2] - PAPER_HEIGHT/fold)*inch2px - inset*inch2px) + 'px';
        pdfHolder.style.marginTop = topTap;

        let fold_code = "";
        if (fold > 1) {
            fold_code = "<path fill='transparent' stroke-dasharray='5,5' stroke='magenta' d='";
            for (let i = 1; i < fold; i++) {
                fold_code += " M1 " + page_height*i/fold + " h" + (LEFT_PANEL_WIDTH - 2);
            }
            fold_code +=  "'/>";
        }
        foldlines.innerHTML = fold_code;

        leftTap = inset*inch2px + "px";
        rightTap = (edata[1] - PAPER_WIDTH - inset)*inch2px + "px";
        left = false;
        tap(true);
    }
}


var _PDF_DOC,
    _CURRENT_PAGE,
    _TOTAL_PAGES,
    _PAGE_RENDERING_IN_PROGRESS = 0,
    _CANVAS = document.querySelector('#pdf-canvas');

async function showPDF(pdf_url) {
    loading.style.display = 'block';

    try {
        _PDF_DOC = await pdfjsLib.getDocument({ url: pdf_url });
    }
    catch(error) {
        alert(error.message);
    }

    _TOTAL_PAGES = _PDF_DOC.numPages;
    
    loading.style.display = 'none';
    pdfCanvas.style.display = 'block';
    pdfControls.style.display = 'block';
    pdfTotalPages.innerHTML = _TOTAL_PAGES;

    showPage(1);
}

// load and render specific page of the PDF
async function showPage(page_no) {
    _PAGE_RENDERING_IN_PROGRESS = 1;
    _CURRENT_PAGE = page_no;
    pdfCurrentPage.innerHTML = page_no;

    pdfNext.disabled = true;
    pdfPrev.disabled = true;

    loading.style.width = _CANVAS.clientWidth + 'px';
    loading.style.height = _CANVAS.clientHeight + 'px';
    loading.style.lineHeight = _CANVAS.clientHeight + 'px';
    pdfCanvas.style.display = 'none';
    loading.style.display = 'block';

    pdfCurrentPage.innerHTML = page_no;
    
    try {
        var page = await _PDF_DOC.getPage(page_no);
    }
    catch(error) {
        alert(error.message);
    }

    var pdf_original_width = page.getViewport(1).width;
    var scale_required = _CANVAS.width / pdf_original_width;
    var viewport = page.getViewport(scale_required);
    _CANVAS.height = viewport.height;

    var render_context = {
        canvasContext: _CANVAS.getContext('2d'),
        viewport: viewport
    };
    try {
        await page.render(render_context);
    }
    catch(error) {
        alert(error.message);
    }

    _PAGE_RENDERING_IN_PROGRESS = 0;

    if (page_no < _TOTAL_PAGES) pdfNext.disabled = false;
    if (page_no > 1) pdfPrev.disabled = false;

//    await wait(2000);

    pdfCanvas.style.display = 'block';
    loading.style.display = 'none';
}

function openPDF(f) {
    showPDF(URL.createObjectURL(f));
}

function prevPage() {
    if(_CURRENT_PAGE > 1) showPage(--_CURRENT_PAGE);
}

function nextPage() {
    if(_CURRENT_PAGE < _TOTAL_PAGES) showPage(++_CURRENT_PAGE);
}

async function wait(t) {
    await new Promise(r => setTimeout(r, t));
}

</script>

</body>
</html>